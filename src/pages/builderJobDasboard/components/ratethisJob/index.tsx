import { useState } from 'react';
import moment from 'moment';
// @ts-ignore
import ReactStars from "react-rating-stars-component";
import { ratingTradieProfile } from '../../../../redux/jobs/actions';
import { setShowToast } from '../../../../redux/common/actions';

import dummy from '../../../../assets/images/u_placeholder.jpg';
import more from '../../../../assets/images/icon-direction-right.png';
import { withRouter } from 'react-router-dom';

interface Proptypes {
    history: any,
    location: any,
    data: any,
    backToScreen: () => void,
}
const RateThisJob = (props: any) => {
    const [reviewBuilderData, setReviewBuilderData] = useState({
        startDate: '',
        endDate: '',
        rating: 0,
        review: '',
    });
    
    let data: any = props?.data;
   
    const ratingChanged = (newRating: number) => {
        console.log(newRating);
        setReviewBuilderData((prevdata: any) => ({ ...prevdata, rating: newRating }))
    };

    const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.value.trim().length <= 250) {
            setReviewBuilderData((prevdata: any) => ({ ...prevdata, review: e.target.value }))
        }
    }

    const startDate = moment(data?.fromDate).format('MMM DD');
    const endDate = moment(data?.toDate).format('MMM DD');

    const submitReviewClicked = async () => {
        if (reviewBuilderData.rating === 0) {
            setShowToast(true, 'Star rating is required');
            return;
        }
        if (reviewBuilderData.review.trim().length < 1) {
            setShowToast(true, 'Review text is required');
            return;
        }
        if (reviewBuilderData.review.trim().length > 1 && reviewBuilderData.rating > 0) {
            const dataItem = {
                jobId: data?.jobId,
                tradieId: data?.tradieId,
                rating: reviewBuilderData.rating,
                review: reviewBuilderData.review.trim()
            }
            const response = await ratingTradieProfile(dataItem);
            if (response?.success) {
                props?.history?.push('/rate-success')
            }
        }
    }

    const jobClickHandler = ({ jobId }: any) => {
        let urlEncode: any = window.btoa(`?jobId=${jobId}`)
        props.history.push(`/job-detail?${urlEncode}`);
    }

    const tradieClicked = ({ tradieId, jobId }: any) => {
        console.log({ props });
        props.history.push(`/tradie-info?tradeId=${tradieId}&jobId=${jobId}`);
    }

    const renderTime = ({ fromDate, toDate }: any) => {
        if (moment(fromDate).isValid() && !moment(toDate).isValid()) {
            return `${moment(fromDate).format('DD MMM')}`
        }

        if (moment(fromDate).isValid() && moment(toDate).isValid()) {
            let yearEnd = moment().endOf("year").toISOString();
            let monthEnd = moment(fromDate).endOf("month").toISOString();

            let item: any = moment(toDate).diff(moment(fromDate), 'months', true);
            let item_year: any = moment(toDate).diff(moment(fromDate), 'years', true);

            let monthDiff = parseInt(item.toString());
            let yearDiff = parseInt(item_year.toString());

            if (yearDiff > 0 || moment(toDate).isAfter(yearEnd) || moment(toDate).isAfter(yearEnd)) {
                return `${moment(fromDate).format('DD MMM YY')} - ${moment(toDate).format('DD MMM YY')}`
            }
            if (monthDiff > 0 || moment(toDate).isAfter(monthEnd)) {
                return `${moment(fromDate).format('DD MMM')} - ${moment(toDate).format('DD MMM')}`
            }
            return `${moment(fromDate).format('DD MMM')} - ${moment(toDate).format('DD')}`
        }
    }

    console.log({ data });
    return (
        <div className="flex_row">
            <div className="flex_col_sm_6">
                <div className="form_field relate">
                    <button className="back" onClick={() => { props?.backToScreen() }}></button>
                    {/* <span className="xs_sub_title">{item?.jobName}</span> */}
                    <span className="xs_sub_title">Review the tradesperson</span>
                </div>
                {/* <div className="form_field">
                    <span className="sub_title">
                        {'Review the tradesperson '}
                    </span>
                </div> */}
                <span className="inner_title">
                    {'Rate this tradie'}
                </span>
                <div className="form_field">
                    <ReactStars
                        count={5}
                        onChange={ratingChanged}
                        size={55}
                        isHalf={true}
                        emptyIcon={<i className="far fa-star"></i>}
                        halfIcon={<i className="fa fa-star-half-alt"></i>}
                        fullIcon={<i className="fa fa-star"></i>}
                        activeColor="#fee600"
                    />
                </div>
                <div className="form_field">
                    <label className="form_label">Comment</label>
                    <div className="text_field">
                        <input
                            type="text"
                            placeholder="Thanks.."
                            maxLength={250}
                            onChange={handleChange}
                        />
                    </div>
                </div>
                <div className="form_field">
                    <button
                        className="fill_btn full_btn btn-effect"
                        onClick={submitReviewClicked}>
                        {'Leave review'}
                    </button>
                </div>
            </div>
            <div className="flex_col_sm_6 col_ruler">
                <>
                    <div className="relate">
                        <span className="sub_title">
                            {'Job details'}
                        </span>
                        <span
                            className="edit_icon"
                            title="More"
                            onClick={() => {
                                jobClickHandler({ jobId: data?.jobId })
                            }}>
                            <img src={more} alt="more" />
                        </span>
                    </div>
                    <div className="tradie_card posted_by view_more ">
                        <div className="user_wrap">
                            <figure className="u_img">
                                <img
                                    src={data?.jobData?.tradeSelectedUrl || dummy}
                                    alt="traide-img"
                                />
                            </figure>
                            <div
                                className="details"
                                onClick={() => {
                                    jobClickHandler({ jobId: data?.jobId })
                                }}>
                                <span className="name">{data?.jobData?.tradeName}</span>
                                <span className="prof">{data?.jobName}</span>
                                <span className="prof">
                                    {renderTime({
                                        fromDate: data?.jobData?.fromDate,
                                        toDate: data?.jobData?.toDate
                                    })}
                                </span>
                            </div>
                        </div>
                    </div>
                </>

                <>
                    <div className="relate">
                        <span className="sub_title">
                            {'Tradie'}
                        </span>
                        <span
                            className="edit_icon"
                            title="More"
                            onClick={() => {
                                tradieClicked({
                                    jobId: data?.jobId,
                                    tradieId: data?.tradieId
                                });
                            }}>
                            <img src={more} alt="more" />
                        </span>
                    </div>
                    <div className="tradie_card posted_by view_more ">
                        <div className="user_wrap">
                            <figure className="u_img">
                                <img src={data?.tradieData?.tradieImage || dummy} alt="traide-img" />
                            </figure>
                            <div
                                className="details"
                                onClick={() => {
                                    tradieClicked({
                                        jobId: data?.jobId,
                                        tradieId: data?.tradieId
                                    });
                                }}>
                                <span className="name">{data?.tradieData?.tradieName}</span>
                                <span className="rating">
                                    {`${data?.tradieData?.ratings || 0} , ${data?.tradieData?.reviews || 0} reviews`}
                                </span>
                            </div>
                        </div>
                    </div>
                </>

            </div>
        </div>
    )
}

export default withRouter(RateThisJob);
